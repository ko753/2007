
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¯ãƒ¬å¾—ï¼ï¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body{margin:0;padding:1em;font-family:sans-serif;background:#f9f9f9;color:#333;}
    header{text-align:center;font-size:2em;margin-bottom:1em;}
    header .crane{display:inline-block;font-style:italic;color:#555;margin-right:0.2em;}
    header .red{color:red;}
    .ticket-section{border-top:1px solid #ccc;margin-top:1em;padding-top:1em;}
    .label{font-weight:bold;font-size:0.9em;margin-bottom:0.5em;}
    .ticket-box{border:2px solid #007bff;border-radius:10px;padding:1em;margin-bottom:1em;background:#e6f0ff;}
    .ticket-box button{margin-top:0.5em;padding:0.5em 1em;font-size:1em;}
    .history-entry{font-size:0.85em;margin-bottom:0.5em;}

.history-entry.daily { color: blue; }
.history-entry.used { color: black; }

    .see-all{color:blue;text-decoration:underline;cursor:pointer;font-size:0.9em;}
    .confirm-page{display:none;text-align:center;margin-top:2em;}
    #no-ticket-msg{color:#a00;font-weight:bold;}
  </style>
</head>
<body>
  <header><span class="crane">ğŸ¤–</span>ã‚¯ãƒ¬<span class="red">å¾—</span>ï¼ï¼</header>

  <div id="main-page">
    <div class="ticket-section">
      <div class="label">ãƒ—ãƒ¬ã‚¤ãƒã‚±ãƒƒãƒˆæ•°</div>
      <div id="ticket-area"></div>
      <div id="no-ticket-msg" style="display:none;">ä½¿ãˆã‚‹ãƒã‚±ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    </div>

    <div class="ticket-section">
      <div class="label">ãƒã‚±ãƒƒãƒˆæ¶ˆè²»å±¥æ­´</div>
      <div id="history"></div>
      <div id="see-all" class="see-all" style="display:none;" onclick="seeAllHistory()">ã™ã¹ã¦ã®å±¥æ­´ã‚’ç¢ºèª</div>
    </div>
  </div>

  <div id="confirm-page" class="confirm-page">
    <p style="font-size:0.9em">ã“ã¡ã‚‰ã®ãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ</p>
    <button onclick="useTicket()">ã¯ã„</button>
    <button onclick="cancelUse()">ã„ã„ãˆ</button>
  </div>

  <script>
    let tickets = [
      { name: "ãƒ‡ã‚¤ãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹åˆ¸", count: 0, expire: "2025-06-12" },
      { name: "é›¨ã®æ—¥ã‚¯ãƒ¼ãƒãƒ³2å›å¢—åŠ ", count: 2, expire: "2025-06-15" }
    ];
    let history = [];

    function formatDate(dateStr) {
      const days = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
      const d = new Date(dateStr);
      return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${days[d.getDay()]})`;
    }

    function isExpired(dateStr) {
      const now = new Date();
      const exp = new Date(dateStr + "T23:59:59");
      return now > exp;
    }

    function renderTickets() {
      const area = document.getElementById("ticket-area");
      area.innerHTML = "";

      // æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã‚’é™¤å¤–
      tickets = tickets.filter(t => !isExpired(t.expire));

      if(tickets.length === 0){
        document.getElementById("no-ticket-msg").style.display = "block";
        return;
      }

      document.getElementById("no-ticket-msg").style.display = "none";

      tickets.forEach((t, i) => {
        const box = document.createElement("div");
        box.className = "ticket-box";
        box.innerHTML = `<strong>${t.name} ${formatDate(t.expire)}ã¾ã§ æ®‹ã‚Š${t.count}æš</strong><br><button onclick="confirmUse(${i})">ä½¿ã†</button>`;
        area.appendChild(box);
      });
    }

    function renderHistory() {
      const h = document.getElementById("history");
      h.innerHTML = "";
      history.slice(0, 10).forEach(e => {
        const div = document.createElement("div");
        div.className = "history-entry";
        div.textContent = e;
        h.appendChild(div);
      });
      document.getElementById("see-all").style.display = history.length > 10 ? "block" : "none";
    }

    function confirmUse(i) {
      sessionStorage.setItem("useIndex", i);
      document.getElementById("main-page").style.display = "none";
      document.getElementById("confirm-page").style.display = "block";
    }

    function useTicket() {
      const i = parseInt(sessionStorage.getItem("useIndex"));
      const ticket = tickets[i];
      if (ticket.count > 0) {
        ticket.count--;
        const now = new Date();
        history.unshift(`${ticket.name} ã‚’ä½¿ç”¨ - ${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${now.getHours()}æ™‚${now.getMinutes()}åˆ†`);
        if (ticket.count === 0) {
          tickets.splice(i, 1); // å‰Šé™¤
        }
      }
      document.getElementById("main-page").style.display = "block";
      document.getElementById("confirm-page").style.display = "none";
      renderTickets();
      renderHistory();
distributeDailyTicketOnce();

    // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«ãƒ‡ã‚¤ãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹åˆ¸ã‚’å³æ™‚é…å¸ƒï¼ˆå½“æ—¥æœªé…å¸ƒãªã‚‰ï¼‰
    function distributeDailyTicketOnce() {
      const now = new Date();
      const today = now.toISOString().slice(0, 10);
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const lastGiven = localStorage.getItem("lastDailyGiven");

      // 00:00ã€œ23:55 ã®é–“ã®ã¿é…å¸ƒå¯¾è±¡
      if (currentHour === 23 && currentMinute > 55) return;

      if (lastGiven !== today + "_onopen") {
        const ticket = tickets.find(t => t.name === "ãƒ‡ã‚¤ãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹åˆ¸");
        if (ticket) {
          ticket.count += 1;
          ticket.expire = today + "T23:59:00";
          localStorage.setItem("lastDailyGiven", today + "_onopen");

          const msg = `${ticket.name} ã‚’ç²å¾— - ${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${now.getHours()}æ™‚${now.getMinutes()}åˆ†`;
          history.unshift(msg);

          renderTickets();
          renderHistory();
distributeDailyTicketOnce();
        }
      }
    } // 30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ // 30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ // 30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯


    // 1åˆ†ã”ã¨ã«ã€Œ1å›å¢—åŠ ã€ãƒã‚±ãƒƒãƒˆã‚’+1ã™ã‚‹
    setInterval(() => {
      const ticket = tickets.find(t => t.name === "1å›å¢—åŠ ");
      if (ticket) {
        ticket.count++;
        renderTickets();
      }
    }, 60000); // 60000ms = 1åˆ†

    }

    function cancelUse() {
      document.getElementById("main-page").style.display = "block";
      document.getElementById("confirm-page").style.display = "none";
    }

    function seeAllHistory() {
      alert(history.join("\n") || "å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    }

    renderTickets();
    renderHistory();
distributeDailyTicketOnce();

    // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«ãƒ‡ã‚¤ãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹åˆ¸ã‚’å³æ™‚é…å¸ƒï¼ˆå½“æ—¥æœªé…å¸ƒãªã‚‰ï¼‰
    function distributeDailyTicketOnce() {
      const now = new Date();
      const today = now.toISOString().slice(0, 10);
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const lastGiven = localStorage.getItem("lastDailyGiven");

      // 00:00ã€œ23:55 ã®é–“ã®ã¿é…å¸ƒå¯¾è±¡
      if (currentHour === 23 && currentMinute > 55) return;

      if (lastGiven !== today + "_onopen") {
        const ticket = tickets.find(t => t.name === "ãƒ‡ã‚¤ãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹åˆ¸");
        if (ticket) {
          ticket.count += 1;
          ticket.expire = today + "T23:59:00";
          localStorage.setItem("lastDailyGiven", today + "_onopen");

          const msg = `${ticket.name} ã‚’ç²å¾— - ${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${now.getHours()}æ™‚${now.getMinutes()}åˆ†`;
          history.unshift(msg);

          renderTickets();
          renderHistory();
distributeDailyTicketOnce();
        }
      }
    } // 30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ // 30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ // 30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯


    // 1åˆ†ã”ã¨ã«ã€Œ1å›å¢—åŠ ã€ãƒã‚±ãƒƒãƒˆã‚’+1ã™ã‚‹
    setInterval(() => {
      const ticket = tickets.find(t => t.name === "1å›å¢—åŠ ");
      if (ticket) {
        ticket.count++;
        renderTickets();
      }
    }, 60000); // 60000ms = 1åˆ†

  </script>
</body>
</html>
